---
id: 99e36072-d15c-4d55-8eed-881d6c9224be
---
sequenceDiagram
  title Google Drive Watch Process

  actor "CI/CD Pipeline"
  participant Watch API
  participant Google Drive API
  participant Data Store API
  participant Cloud Task

  "CI/CD Pipeline" ->> Watch API: Deploy & Initialize Watch

  note over Watch API, Data Store API: General Exception Handling:<br/>All subsequent API calls will return 500 on failure.<br/>Details omitted for brevity.

  par "Get startPageTokens to prevent race condition"
    Watch API ->> Google Drive API: get startPageToken
  and
    Watch API ->> Data Store API: get startPageToken
  end

  Google Drive API -->> Watch API: startPageToken
  Data Store API -->> Watch API: startPageToken

  alt "Critical Exception: startPageTokens mismatch"
    note over Watch API: Mismatch detected. Scheduling a retry.
    Watch API ->> Cloud Task: add retry task (e.g., after 5 mins)
  else "Happy Path: Tokens match"
    note over Watch API: Tokens match. Proceeding to watch.
    Watch API ->> Data Store API: set startPageToken
    Watch API ->> Google Drive API: watch drive
    Google Drive API -->> Watch API: {channelId, resourceId, expiration}
    Watch API ->> Cloud Task: add renewal task before expiration
  end

  note over Cloud Task, Watch API: Later...
  Cloud Task ->> Watch API: Execute scheduled task (retry or renewal)