sequenceDiagram
  title Monthly Ledger Generation Process

  actor User
  participant Drive API
  participant Ledger API
  participant Data Store API
  participant Vertex AI API
  participant Cloud Task

  note over Ledger API, Cloud Task: General Exception Handling:<br/>All subsequent API calls will return 500 on failure.<br/>Details are omitted for brevity.

  User ->> Drive API: File changes trigger webhook
  Drive API ->> Ledger API: Notify changes

  break Invalid Request or Already Processing
    note over Drive API, Ledger API: If the request is invalid or another process is running, stop.
    Ledger API -->> Drive API: Respond 401/202.
  end

  Ledger API ->> Data Store API: Set isProcessing = true

  alt Happy Path: Ledger Generation Succeeds
    note over Ledger API, Drive API: Process data and create/update ledger in Drive.<br/>(See 'process_ledger_data_sequence.mmd' for details)
    Ledger API ->> Drive API: Create/Update Monthly Ledger
    
    Ledger API ->> Data Store API: Set newStartPageToken & isProcessing = false

    Ledger API ->> Drive API: Get latest startPageToken
    Drive API -->> Ledger API: currentStartPageToken
    opt newStartPageToken != currentStartPageToken
      note over Ledger API, Cloud Task: If new changes occurred, schedule another generation task.
      Ledger API ->> Cloud Task: Create generation task
    end

    Ledger API -->> Drive API: 200 OK

  else Failure: Rollback and Retry
    note over Ledger API, Cloud Task: An error occurred during generation. Reverting state.
    Ledger API ->> Data Store API: Set isProcessing = false
    Ledger API ->> Cloud Task: Schedule a retry task
    break Process stops after scheduling retry
      Ledger API -->> Drive API: 500 Internal Server Error
    end
  end
